<!doctype html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<th:block th:replace="~{/layout/index :: setContent(~{this::content})}">
  <th:block th:fragment="content">
    <h1>Guestbook Register Page</h1>
    <form th:action="@{/movie/register}" method="post" class="register-form">
      <div class="form-group my-3">
        <label>Title</label>
        <input type="text" class="form-control" name="title" placeholder="Title">
      </div>
      <div class="form-group my-3">
        <label>Imgae Files</label>
        <input type="file" accept="image/*" class="form-control" id="files" multiple>
      </div>

      <ul class="box my-3" id="imgList">

      </ul>
      <button type="submit" class="btn btn-primary mt-3">Submit</button>
    </form>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/1.11.0/axios.min.js" integrity="sha512-h9644v03pHqrIHThkvXhB2PJ8zf5E9IyVnrSfZg8Yj8k4RsO4zldcQc4Bi9iVLUCCsqNY0b4WXVV4UB+wbWENA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script>
      window.onload = _ => {
        document.querySelector("#imgList").addEventListener("click", e => {
          if(e.target.matches(".btn-close")) {
            e.target.closest("li").remove();
          }
        })


        document.querySelector(".register-form").addEventListener("submit", e => {
          e.preventDefault();
          document.querySelector("#imgList").insertAdjacentHTML("afterend", [... document.querySelectorAll("#imgList li")].map((el, i) => {
            const obj = {...el.dataset};
            console.log(obj)
            let str = "";
            for(const x in obj) {
              str += `<input type="hidden" name="list[${i}].${x}" value="${obj[x]}">`;
            }
            return str;
          }).join(""));
          e.target.submit();
        })

      }



      document.querySelector("#files").addEventListener('change', (event) => {
        event.preventDefault();
        const formData = new FormData();

        const files = document.querySelector("[type=file]").files;
        [...files].forEach(file => {formData.append("files", file);
        });

        (async () => {
          try {
            const resp = await axios.post('/uploadAjax', formData, {
              headers: {
                "Content-Type": "multipart/form-data"
              }
            });
            document.querySelector("#imgList").innerHTML += resp.data.map(file =>
                `<li data-uuid="${file.uuid}" data-origin="${file.origin}" data-path="${file.path}">
<img src="/display${file.thumb}" alt="${file.origin}"><button class="btn btn-close"></button>
</li>`
            ).join('');
            console.log("업로드 완료")
          } catch (error) {
            console.log(error);
            const status = error.response.status;
            if(status === 400) {
              alert(error.response.data);
            }
            else if (status == 500){
              alert("서버 오류가 발생했습니다.")
            }
            else {
              alert("알수 없는 오류" + status);
            }
          }

        })();
      })


    </script>
  </th:block>
</th:block>
</html>